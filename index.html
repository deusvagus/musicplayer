<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音樂播放器</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="page-container">
    <header class="header">
      <div class="header-content">
        <i class="fas fa-music header-icon"></i>
        <h1 class="header-title">音樂播放器</h1>
        <p class="header-subtitle">網易雲內嵌測試</p>
      </div>
      <div class="header-bg"></div>
    </header>

    <div class="app-body">
      <aside class="sidebar">
        <div class="sidebar-sticky">
          <h2>專輯目錄</h2>
          
          <div class="search-section">
            <input type="search" id="searchInput" placeholder="搜尋曲目、ID 或專輯...">
          </div>

          <div class="advanced-search-section">
            <h4>進階搜尋</h4>
            <input type="search" id="searchField" placeholder="搜尋欄位 (如: 作曲)">
            <input type="search" id="searchValue" placeholder="搜尋內容...">
          </div>

          <nav id="toc" class="table-of-contents"></nav>
        </div>
      </aside>

      <main class="main-content" id="albumContainer">
        </main>
    </div>

    <footer class="footer">
      <p>&copy; 2025 音樂播放器. 測試網頁.</p>
    </footer>
  </div>

  <style>
    :root {
      --primary-color-start: #667eea;
      --primary-color-end: #764ba2;
      --card-bg: rgba(255,255,255,0.95);
      --text-color: #333;
      --sidebar-width: 320px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
    }

    .page-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header Styles */
    .header {
      position: relative;
      padding: 2rem;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header-icon { font-size: 2.5rem; margin-bottom: 0.5rem; animation: pulse 2s ease-in-out infinite; }
    .header-title { font-size: 2.2rem; }
    .header-subtitle { font-size: 1.1rem; opacity: 0.9; }

    /* App Body Layout */
    .app-body {
      display: flex;
      flex: 1;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      padding: 2rem;
      flex-shrink: 0;
    }
    .sidebar-sticky {
      position: sticky;
      top: 2rem;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1.5rem;
      color: white;
    }
    .sidebar h2 { margin-bottom: 1.5rem; font-weight: 600; }
    
    .search-section, .advanced-search-section {
        margin-bottom: 1.5rem;
    }
    .advanced-search-section h4 {
        margin-bottom: 0.75rem;
        font-weight: 500;
    }

    #searchInput, #searchField, #searchValue {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
    }
    #searchField { margin-bottom: 0.5rem; }
    #searchInput::placeholder, #searchField::placeholder, #searchValue::placeholder { color: rgba(255,255,255,0.7); }

    .table-of-contents {
      list-style: none;
      max-height: 55vh;
      overflow-y: auto;
    }
    .table-of-contents a {
      display: block;
      padding: 0.5rem;
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    .table-of-contents a:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      min-width: 0;
    }

    /* Album Section */
    .album-section { margin-bottom: 2rem; }
    .album-summary {
      font-size: 1.8rem;
      font-weight: 600;
      padding: 1rem;
      cursor: pointer;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      color: white;
      border-radius: 15px;
      transition: background 0.3s ease;
    }
    .album-summary:hover { background: rgba(255,255,255,0.3); }
    .album-section[open] > .album-summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .music-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
      background: rgba(255,255,255,0.4);
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    /* Music Card Styles */
    .music-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .music-card:hover { transform: translateY(-5px); }
    .card-header { display: flex; align-items: center; margin-bottom: 1rem; }
    .music-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; }
    .music-icon i { font-size: 1.5rem; color: #fff; }
    .track-info { min-width: 0; }
    .track-info h3 { font-size: 1.3rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .track-id { color: #666; font-size: 0.9rem; }
    .track-title-en { color: #888; font-size: 0.85rem; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    
    .card-body { border-top: 1px solid rgba(0,0,0,0.1); padding-top: 1rem; }
    .click-to-load { text-align: center; padding: 1.5rem; color: #666; background: rgba(0,0,0,0.05); border-radius: 10px; border: 2px dashed rgba(0,0,0,0.1); cursor: pointer; }
    .loading { text-align: center; padding: 2rem; color: var(--primary-color-start); }
    .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
    .player-wrapper { border-radius: 10px; overflow: hidden; margin-top: 1rem; }

    .details-toggle {
        display: inline-block;
        margin-top: 1rem;
        padding: 0.4rem 0.8rem;
        background: rgba(0,0,0,0.05);
        color: #555;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }
    .details-toggle:hover { background: rgba(0,0,0,0.1); }
    .track-details {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        font-size: 0.9rem;
    }
    .track-details p { margin-bottom: 0.5rem; }
    .track-details strong { color: var(--primary-color-end); }
    .hidden { display: none !important; }

    /* Footer */
    .footer { text-align: center; padding: 2rem; color: #fff; background: rgba(0,0,0,0.1); }

    /* Animations */
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 1024px) {
      .app-body { flex-direction: column; }
      .sidebar { width: 100%; padding-bottom: 0; }
      .sidebar-sticky { position: static; }
      .table-of-contents { max-height: 200px; }
    }
  </style>

<script>
    // --- UTILITY FUNCTIONS ---

    function createMusicCard(music) {
        const card = document.createElement('div');
        card.className = 'music-card';
        card.dataset.id = music.id;
        
        // 用於一般搜尋的數據
        card.dataset.searchText = `${music.title} ${music.subtitle || ''} ${music.id}`.toLowerCase();
        
        // 用於進階搜尋的數據
        if (music.details) {
            card.dataset.details = JSON.stringify(music.details);
        }

        let detailsHtml = '';
        if (music.details && Object.keys(music.details).length > 0) {
            const detailsContent = Object.entries(music.details)
                .filter(([key]) => key !== 'track' && key !== 'album' && key !== 'date') // 過濾掉不需要顯示的欄位
                .map(([key, value]) => `<p><strong>${key}:</strong> ${value}</p>`)
                .join('');
            
            detailsHtml = `
                <span class="details-toggle" onclick="toggleDetails(this)">
                    <i class="fas fa-info-circle"></i> 詳細資訊
                </span>
                <div class="track-details">
                    ${detailsContent}
                </div>
            `;
        }

        card.innerHTML = `
            <div class="card-header">
                <div class="music-icon"><i class="fas fa-play-circle"></i></div>
                <div class="track-info">
                    <h3 class="track-title">${music.title}</h3>
                    <p class="track-id">ID: ${music.id}</p>
                    ${music.subtitle ? `<p class="track-title-en">${music.subtitle}</p>` : ''}
                </div>
            </div>
            ${detailsHtml}
            <div class="card-body">
              <div class="click-to-load" onclick="loadPlayer('${music.id}', this)">
                  <i class="fas fa-music"></i>
                  <p>點擊加載播放器</p>
              </div>
            </div>
        `;
        return card;
    }

    function loadPlayer(id, element) {
        const card = element.closest('.music-card');
        if (card.classList.contains('loaded')) return;

        element.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i><p>正在加載...</p></div>`;
        
        setTimeout(() => {
            const playerWrapper = document.createElement('div');
            playerWrapper.className = 'player-wrapper';
            playerWrapper.innerHTML = `
                <iframe frameborder="0" border="0" marginwidth="0" marginheight="0" width="100%" height="86"
                    src="https://music.163.com/outchain/player?type=2&id=${id}&auto=0&height=66">
                </iframe>`;
            
            element.replaceWith(playerWrapper);
            card.classList.add('loaded');
            card.querySelector('.music-icon i').className = 'fas fa-stop-circle';
        }, 500);
    }

    function toggleDetails(element) {
        const detailsDiv = element.nextElementSibling;
        const isDisplayed = detailsDiv.style.display === 'block';
        detailsDiv.style.display = isDisplayed ? 'none' : 'block';
        element.innerHTML = isDisplayed 
            ? '<i class="fas fa-info-circle"></i> 詳細資訊'
            : '<i class="fas fa-chevron-up"></i> 收合資訊';
    }


    // --- MAIN APPLICATION LOGIC ---

    document.addEventListener('DOMContentLoaded', function() {
        const albumContainer = document.getElementById('albumContainer');
        const toc = document.getElementById('toc');
        const searchInput = document.getElementById('searchInput');
        const searchFieldInput = document.getElementById('searchField');
        const searchValueInput = document.getElementById('searchValue');

        let allTracksData = []; // 用於儲存所有合併後的曲目資料

        async function initializeApp() {
            try {
                // 1. 獲取所有詳細資訊
                const lyricsManifestResponse = await fetch('lyrics/manifest_lyrics.json');
                if (!lyricsManifestResponse.ok) throw new Error('無法加載 lyrics/manifest_lyrics.json');
                const lyricsManifest = await lyricsManifestResponse.json();
                
                const detailPromises = lyricsManifest.albums.map(file => 
                    fetch(`lyrics/${file}`).then(res => res.json())
                );
                const settledDetails = await Promise.allSettled(detailPromises);

                const trackDetailsMap = new Map();
                settledDetails.forEach(result => {
                    if (result.status === 'fulfilled') {
                        result.value.forEach(albumData => {
                            albumData.tracks.forEach(track => {
                                trackDetailsMap.set(track.track, track); // 使用曲目全名作為 key
                            });
                        });
                    }
                });

                // 2. 讀取基礎曲目ID列表
                const manifestResponse = await fetch('IDs/manifest.json');
                if (!manifestResponse.ok) throw new Error('無法加載 IDs/manifest.json');
                const manifest = await manifestResponse.json();
                const albumFiles = manifest.albums;

                const albumPromises = albumFiles.map(filename =>
                    fetch(`IDs/${filename}`)
                    .then(res => res.ok ? res.text() : Promise.reject(`無法加載 ${filename}`))
                    .then(text => ({
                        title: filename.replace('.txt', '').replace(/_/g, ' '),
                        content: text
                    }))
                );
                const settledAlbums = await Promise.allSettled(albumPromises);

                // 3. 解析並合併資料
                const allAlbumData = settledAlbums
                    .filter(result => result.status === 'fulfilled')
                    .map(result => {
                        const album = result.value;
                        const tracks = album.content.trim().split('\n').map(line => {
                            const parts = line.split('\t');
                            if (parts.length < 2) return null;
                            
                            const id = parts[0].trim();
                            const fullTitle = parts[1].trim();
                            const [title, ...subtitleParts] = fullTitle.split(' '); // 假設英文名用空格分隔

                            const mergedTrack = {
                                id,
                                title: title,
                                subtitle: subtitleParts.join(' ') || null,
                                details: trackDetailsMap.get(fullTitle) || null // 根據完整曲目名查找詳細資訊
                            };
                            allTracksData.push(mergedTrack); // 儲存到全域變數
                            return mergedTrack;
                        }).filter(Boolean);

                        return { title: album.title, tracks };
                    });

                // 4. 渲染頁面
                renderPage(allAlbumData);

            } catch (error) {
                albumContainer.innerHTML = `<p style="color: white; font-size: 1.2rem; text-align: center;">初始化失敗: ${error.message}</p>`;
                console.error('初始化失敗:', error);
            }
        }

        function renderPage(allAlbumData) {
            albumContainer.innerHTML = '';
            toc.innerHTML = '';

            if (allAlbumData.length === 0) {
                albumContainer.innerHTML = `<p style="color: white; text-align: center;">沒有找到任何專輯資料。</p>`;
                return;
            }

            allAlbumData.forEach((album, index) => {
                const albumId = `album-${index}`;

                const tocLink = document.createElement('a');
                tocLink.href = `#${albumId}`;
                tocLink.textContent = album.title;
                tocLink.onclick = (e) => {
                    e.preventDefault();
                    const target = document.getElementById(albumId);
                    if (target) {
                        target.open = true;
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                };
                toc.appendChild(tocLink);
                
                const albumSection = document.createElement('details');
                albumSection.className = 'album-section';
                albumSection.id = albumId;
                albumSection.open = true;
                albumSection.dataset.albumTitle = album.title.toLowerCase();

                const summary = document.createElement('summary');
                summary.className = 'album-summary';
                summary.textContent = album.title;
                
                const musicGrid = document.createElement('div');
                musicGrid.className = 'music-grid';

                album.tracks.forEach(track => {
                    musicGrid.appendChild(createMusicCard(track));
                });
                
                albumSection.appendChild(summary);
                albumSection.appendChild(musicGrid);
                albumContainer.appendChild(albumSection);
            });
        }

        function updateFilter() {
            const generalQuery = searchInput.value.toLowerCase().trim();
            const fieldQuery = searchFieldInput.value.toLowerCase().trim();
            const valueQuery = searchValueInput.value.toLowerCase().trim();
            
            const allCards = document.querySelectorAll('.music-card');
            const allAlbumSections = document.querySelectorAll('.album-section');

            allCards.forEach(card => {
                // 檢查一般搜尋
                const generalMatch = card.dataset.searchText.includes(generalQuery);

                // 檢查進階搜尋
                let advancedMatch = true;
                if (fieldQuery && valueQuery) {
                    advancedMatch = false; // 預設為不匹配，除非找到
                    const details = card.dataset.details ? JSON.parse(card.dataset.details) : null;
                    if (details) {
                       for (const key in details) {
                           // 讓使用者可以用中文或英文模糊搜尋欄位
                           if (key.toLowerCase().includes(fieldQuery)) {
                               const value = String(details[key]).toLowerCase();
                               if (value.includes(valueQuery)) {
                                   advancedMatch = true;
                                   break; // 找到一個匹配就跳出迴圈
                               }
                           }
                       }
                    }
                }
                
                const isVisible = generalMatch && advancedMatch;
                card.classList.toggle('hidden', !isVisible);
            });

            allAlbumSections.forEach(section => {
                const hasVisibleCards = section.querySelector('.music-card:not(.hidden)');
                const albumTitleMatch = section.dataset.albumTitle.includes(generalQuery);
                const isSectionVisible = hasVisibleCards || (albumTitleMatch && !fieldQuery && !valueQuery);
                
                section.classList.toggle('hidden', !isSectionVisible);
                if ((generalQuery || (fieldQuery && valueQuery)) && isSectionVisible) {
                    section.open = true;
                }
            });
        }

        searchInput.addEventListener('input', updateFilter);
        searchFieldInput.addEventListener('input', updateFilter);
        searchValueInput.addEventListener('input', updateFilter);

        initializeApp();
    });
</script>

</body>
</html>