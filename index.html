<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音樂播放器</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="page-container">
    <header class="header">
      <div class="header-content">
        <i class="fas fa-music header-icon"></i>
        <h1 class="header-title">音樂播放器</h1>
        <p class="header-subtitle">網易雲內嵌測試</p>
      </div>
      <div class="header-bg"></div>
    </header>

    <div class="app-body">
      <aside class="sidebar">
        <div class="sidebar-sticky">
          <h2>專輯目錄</h2>
          <input type="search" id="searchInput" placeholder="搜尋曲目、ID 或專輯...">
          <nav id="toc" class="table-of-contents"></nav>
        </div>
      </aside>

      <main class="main-content" id="albumContainer">
        </main>
    </div>

    <footer class="footer">
      <p>&copy; 2025 音樂播放器. 測試網頁.</p>
    </footer>
  </div>

  <style>
    :root {
      --primary-color-start: #667eea;
      --primary-color-end: #764ba2;
      --card-bg: rgba(255,255,255,0.95);
      --text-color: #333;
      --sidebar-width: 300px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
    }

    .page-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header Styles */
    .header {
      position: relative;
      padding: 2rem;
      text-align: center;
      color: white;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .header-icon { font-size: 2.5rem; margin-bottom: 0.5rem; animation: pulse 2s ease-in-out infinite; }
    .header-title { font-size: 2.2rem; }
    .header-subtitle { font-size: 1.1rem; opacity: 0.9; }

    /* App Body Layout */
    .app-body {
      display: flex;
      flex: 1;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      padding: 2rem;
      flex-shrink: 0;
    }
    .sidebar-sticky {
      position: sticky;
      top: 2rem;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1.5rem;
      color: white;
    }
    .sidebar h2 { margin-bottom: 1.5rem; font-weight: 600; }
    
    #searchInput {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      margin-bottom: 1.5rem;
    }
    #searchInput::placeholder { color: rgba(255,255,255,0.7); }

    .table-of-contents {
      list-style: none;
      max-height: 60vh;
      overflow-y: auto;
    }
    .table-of-contents a {
      display: block;
      padding: 0.5rem;
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    .table-of-contents a:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .main-content {
      flex: 1;
      padding: 2rem;
      min-width: 0; /* Prevents flexbox overflow */
    }

    /* Album Section */
    .album-section {
      margin-bottom: 2rem;
    }
    .album-summary {
      font-size: 1.8rem;
      font-weight: 600;
      padding: 1rem;
      cursor: pointer;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      color: white;
      border-radius: 15px;
      transition: background 0.3s ease;
    }
    .album-summary:hover {
      background: rgba(255,255,255,0.3);
    }
    .album-section[open] > .album-summary {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .music-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
      background: rgba(255,255,255,0.4);
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    /* Music Card Styles (mostly unchanged) */
    .music-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .music-card:hover { transform: translateY(-5px); }
    .card-header { display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .music-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
    .music-icon i { font-size: 1.5rem; color: #fff; }
    .track-info h3 { font-size: 1.3rem; margin-bottom: 0.25rem; }
    .track-id { color: #666; font-size: 0.9rem; }
    .track-title-en { color: #888; font-size: 0.85rem; font-style: italic; }
    .click-to-load { text-align: center; padding: 2rem; color: #666; background: rgba(0,0,0,0.05); border-radius: 10px; border: 2px dashed rgba(0,0,0,0.1); }
    .loading { text-align: center; padding: 2rem; color: var(--primary-color-start); }
    .loading i { font-size: 2rem; animation: spin 1s linear infinite; }
    .player-wrapper { border-radius: 10px; overflow: hidden; margin-top: 1rem; }
    .hidden { display: none !important; }

    /* Footer */
    .footer { text-align: center; padding: 2rem; color: #fff; background: rgba(0,0,0,0.1); }

    /* Animations */
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 1024px) {
      .app-body { flex-direction: column; }
      .sidebar { width: 100%; padding-bottom: 0; }
      .sidebar-sticky { position: static; }
      .table-of-contents { max-height: 200px; }
    }
  </style>

  <script>
    // --- UTILITY FUNCTIONS ---

    // 創建音樂卡片 HTML
    function createMusicCard(music) {
      const card = document.createElement('div');
      card.className = 'music-card';
      card.dataset.id = music.id;
      // 用於搜尋的數據
      card.dataset.searchText = `${music.title} ${music.subtitle || ''} ${music.id}`.toLowerCase();
      
      card.innerHTML = `
        <div class="card-header">
          <div class="music-icon"><i class="fas fa-play-circle"></i></div>
          <div class="track-info">
            <h3 class="track-title">${music.title}</h3>
            <p class="track-id">ID: ${music.id}</p>
            ${music.subtitle ? `<p class="track-title-en">${music.subtitle}</p>` : ''}
          </div>
        </div>
        <div class="click-to-load" onclick="loadPlayer('${music.id}', this)">
          <i class="fas fa-music"></i>
          <p>點擊加載播放器</p>
        </div>
      `;
      return card;
    }

    // 加載網易雲播放器
    function loadPlayer(id, element) {
      const card = element.closest('.music-card');
      if (card.classList.contains('loaded')) return;

      element.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i><p>正在加載...</p></div>`;
      
      setTimeout(() => {
        const playerWrapper = document.createElement('div');
        playerWrapper.className = 'player-wrapper';
        playerWrapper.innerHTML = `
          <iframe frameborder="0" border="0" marginwidth="0" marginheight="0" width="100%" height="86"
            src="https://music.163.com/outchain/player?type=2&id=${id}&auto=0&height=66">
          </iframe>`;
        
        element.replaceWith(playerWrapper);
        card.classList.add('loaded');
        card.querySelector('.music-icon i').className = 'fas fa-stop-circle';
      }, 500);
    }

    // --- MAIN APPLICATION LOGIC ---

    document.addEventListener('DOMContentLoaded', function() {
      const albumContainer = document.getElementById('albumContainer');
      const toc = document.getElementById('toc');
      const searchInput = document.getElementById('searchInput');

      // 初始化應用
      async function initializeApp() {
        try {
          // 1. 讀取 manifest.json 獲取專輯列表
          const manifestResponse = await fetch('IDs/manifest.json');
          if (!manifestResponse.ok) throw new Error('無法加載 manifest.json，請檢查檔案是否存在於 IDs 資料夾中。');
          const manifest = await manifestResponse.json();
          const albumFiles = manifest.albums;

          // 2. 平行獲取所有專輯檔案的內容
          const albumPromises = albumFiles.map(filename => 
            fetch(`IDs/${filename}`)
              .then(res => res.ok ? res.text() : Promise.reject(`無法加載 ${filename}`))
              .then(text => ({
                title: filename.replace('.txt', ''),
                content: text
              }))
          );
          const settledAlbums = await Promise.allSettled(albumPromises);
          
          // 3. 解析檔案內容並建立數據結構
          const allAlbumData = settledAlbums
            .filter(result => result.status === 'fulfilled')
            .map(result => {
              const album = result.value;
              const tracks = album.content.trim().split('\n').map(line => {
                const parts = line.split('\t');
                if (parts.length < 2) return null;
                
                const id = parts[0].trim();
                const [title, ...subtitleParts] = parts[1].trim().split('_');
                
                return {
                  id,
                  title,
                  subtitle: subtitleParts.join('_') || null
                };
              }).filter(Boolean); // 過濾掉解析失敗的行

              return { title: album.title, tracks };
            });

          // 4. 渲染頁面
          renderPage(allAlbumData);

        } catch (error) {
          albumContainer.innerHTML = `<p style="color: white; font-size: 1.2rem; text-align: center;">${error.message}</p>`;
          console.error('初始化失敗:', error);
        }
      }

      // 根據數據渲染整個頁面
      function renderPage(allAlbumData) {
        albumContainer.innerHTML = ''; // 清空現有內容
        toc.innerHTML = '';

        if (allAlbumData.length === 0) {
            albumContainer.innerHTML = `<p style="color: white; text-align: center;">沒有找到任何專輯資料。</p>`;
            return;
        }

        allAlbumData.forEach((album, index) => {
          const albumId = `album-${index}`;

          // 創建目錄連結
          const tocLink = document.createElement('a');
          tocLink.href = `#${albumId}`;
          tocLink.textContent = album.title;
          tocLink.onclick = (e) => {
            e.preventDefault();
            const target = document.getElementById(albumId);
            if (target) {
                target.open = true;
                target.scrollIntoView({ behavior: 'smooth' });
            }
          };
          toc.appendChild(tocLink);
          
          // 創建專輯區塊
          const albumSection = document.createElement('details');
          albumSection.className = 'album-section';
          albumSection.id = albumId;
          albumSection.open = true; // 預設展開
          albumSection.dataset.albumTitle = album.title.toLowerCase();

          const summary = document.createElement('summary');
          summary.className = 'album-summary';
          summary.textContent = album.title;
          
          const musicGrid = document.createElement('div');
          musicGrid.className = 'music-grid';

          album.tracks.forEach(track => {
            musicGrid.appendChild(createMusicCard(track));
          });
          
          albumSection.appendChild(summary);
          albumSection.appendChild(musicGrid);
          albumContainer.appendChild(albumSection);
        });
      }

      // 處理搜尋功能
      function handleSearch() {
        const query = searchInput.value.toLowerCase().trim();
        const allCards = document.querySelectorAll('.music-card');
        const allAlbumSections = document.querySelectorAll('.album-section');

        allCards.forEach(card => {
          const isVisible = card.dataset.searchText.includes(query);
          card.classList.toggle('hidden', !isVisible);
        });

        allAlbumSections.forEach(section => {
          const hasVisibleCards = section.querySelector('.music-card:not(.hidden)');
          const albumTitleMatch = section.dataset.albumTitle.includes(query);
          const isSectionVisible = hasVisibleCards || albumTitleMatch;
          
          section.classList.toggle('hidden', !isSectionVisible);
          if (query && isSectionVisible) {
            section.open = true; // 在搜尋時自動展開符合條件的區塊
          }
        });
      }

      searchInput.addEventListener('input', handleSearch);
      initializeApp();
    });
  </script>
</body>
</html>